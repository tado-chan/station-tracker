"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4772],{2126:(bt,st,E)=>{E.d(st,{E_:()=>V,F3:()=>Z});var h=E(3308),T=function(p){return p.Unimplemented="UNIMPLEMENTED",p.Unavailable="UNAVAILABLE",p}(T||{});class M extends Error{constructor(s,c,S){super(s),this.message=s,this.code=c,this.data=S}}const at=p=>{const s=p.CapacitorCustomPlatform||null,c=p.Capacitor||{},S=c.Plugins=c.Plugins||{},v=()=>null!==s?s.name:(p=>{var s,c;return p?.androidBridge?"android":null!==(c=null===(s=p?.webkit)||void 0===s?void 0:s.messageHandlers)&&void 0!==c&&c.bridge?"ios":"web"})(p),_=F=>{var k;return null===(k=c.PluginHeaders)||void 0===k?void 0:k.find(W=>W.name===F)},w=new Map;return c.convertFileSrc||(c.convertFileSrc=F=>F),c.getPlatform=v,c.handleError=F=>p.console.error(F),c.isNativePlatform=()=>"web"!==v(),c.isPluginAvailable=F=>{const k=w.get(F);return!(!k?.platforms.has(v())&&!_(F))},c.registerPlugin=(F,k={})=>{const W=w.get(F);if(W)return console.warn(`Capacitor plugin "${F}" already registered. Cannot register plugins twice.`),W.proxy;const N=v(),$=_(F);let z;const lt=function(){var I=(0,h.A)(function*(){return!z&&N in k?z=z="function"==typeof k[N]?yield k[N]():k[N]:null!==s&&!z&&"web"in k&&(z=z="function"==typeof k.web?yield k.web():k.web),z});return function(){return I.apply(this,arguments)}}(),nt=I=>{let C;const L=(...j)=>{const B=lt().then(R=>{const U=((I,C)=>{var L,j;if(!$){if(I)return null===(j=I[C])||void 0===j?void 0:j.bind(I);throw new M(`"${F}" plugin is not implemented on ${N}`,T.Unimplemented)}{const B=$?.methods.find(R=>C===R.name);if(B)return"promise"===B.rtype?R=>c.nativePromise(F,C.toString(),R):(R,U)=>c.nativeCallback(F,C.toString(),R,U);if(I)return null===(L=I[C])||void 0===L?void 0:L.bind(I)}})(R,I);if(U){const K=U(...j);return C=K?.remove,K}throw new M(`"${F}.${I}()" is not implemented on ${N}`,T.Unimplemented)});return"addListener"===I&&(B.remove=(0,h.A)(function*(){return C()})),B};return L.toString=()=>`${I.toString()}() { [capacitor code] }`,Object.defineProperty(L,"name",{value:I,writable:!1,configurable:!1}),L},it=nt("addListener"),ot=nt("removeListener"),dt=(I,C)=>{const L=it({eventName:I},C),j=function(){var R=(0,h.A)(function*(){const U=yield L;ot({eventName:I,callbackId:U},C)});return function(){return R.apply(this,arguments)}}(),B=new Promise(R=>L.then(()=>R({remove:j})));return B.remove=(0,h.A)(function*(){console.warn("Using addListener() without 'await' is deprecated."),yield j()}),B},e=new Proxy({},{get(I,C){switch(C){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return $?dt:it;case"removeListener":return ot;default:return nt(C)}}});return S[F]=e,w.set(F,{name:F,proxy:e,platforms:new Set([...Object.keys(k),...$?[N]:[]])}),e},c.Exception=M,c.DEBUG=!!c.DEBUG,c.isLoggingEnabled=!!c.isLoggingEnabled,c},q=(p=>p.Capacitor=at(p))(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),Z=q.registerPlugin;class V{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(s,c){var S=this;let v=!1;this.listeners[s]||(this.listeners[s]=[],v=!0),this.listeners[s].push(c);const A=this.windowListeners[s];A&&!A.registered&&this.addWindowListener(A),v&&this.sendRetainedArgumentsForEvent(s);const _=function(){var w=(0,h.A)(function*(){return S.removeListener(s,c)});return function(){return w.apply(this,arguments)}}();return Promise.resolve({remove:_})}removeAllListeners(){var s=this;return(0,h.A)(function*(){s.listeners={};for(const c in s.windowListeners)s.removeWindowListener(s.windowListeners[c]);s.windowListeners={}})()}notifyListeners(s,c,S){const v=this.listeners[s];if(v)v.forEach(y=>y(c));else if(S){let y=this.retainedEventArguments[s];y||(y=[]),y.push(c),this.retainedEventArguments[s]=y}}hasListeners(s){var c;return!(null===(c=this.listeners[s])||void 0===c||!c.length)}registerWindowListener(s,c){this.windowListeners[c]={registered:!1,windowEventName:s,pluginEventName:c,handler:S=>{this.notifyListeners(c,S)}}}unimplemented(s="not implemented"){return new q.Exception(s,T.Unimplemented)}unavailable(s="not available"){return new q.Exception(s,T.Unavailable)}removeListener(s,c){var S=this;return(0,h.A)(function*(){const v=S.listeners[s];if(!v)return;const y=v.indexOf(c);S.listeners[s].splice(y,1),S.listeners[s].length||S.removeWindowListener(S.windowListeners[s])})()}addWindowListener(s){window.addEventListener(s.windowEventName,s.handler),s.registered=!0}removeWindowListener(s){s&&(window.removeEventListener(s.windowEventName,s.handler),s.registered=!1)}sendRetainedArgumentsForEvent(s){const c=this.retainedEventArguments[s];c&&(delete this.retainedEventArguments[s],c.forEach(S=>{this.notifyListeners(s,S)}))}}const rt=p=>encodeURIComponent(p).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Q=p=>p.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Y extends V{getCookies(){return(0,h.A)(function*(){const s=document.cookie,c={};return s.split(";").forEach(S=>{if(S.length<=0)return;let[v,y]=S.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");v=Q(v).trim(),y=Q(y).trim(),c[v]=y}),c})()}setCookie(s){return(0,h.A)(function*(){try{const c=rt(s.key),S=rt(s.value),v=`; expires=${(s.expires||"").replace("expires=","")}`,y=(s.path||"/").replace("path=",""),A=null!=s.url&&s.url.length>0?`domain=${s.url}`:"";document.cookie=`${c}=${S||""}${v}; path=${y}; ${A};`}catch(c){return Promise.reject(c)}})()}deleteCookie(s){return(0,h.A)(function*(){try{document.cookie=`${s.key}=; Max-Age=0`}catch(c){return Promise.reject(c)}})()}clearCookies(){return(0,h.A)(function*(){try{const s=document.cookie.split(";")||[];for(const c of s)document.cookie=c.replace(/^ +/,"").replace(/=.*/,`=;expires=${(new Date).toUTCString()};path=/`)}catch(s){return Promise.reject(s)}})()}clearAllCookies(){var s=this;return(0,h.A)(function*(){try{yield s.clearCookies()}catch(c){return Promise.reject(c)}})()}}Z("CapacitorCookies",{web:()=>new Y});const X=function(){var p=(0,h.A)(function*(s){return new Promise((c,S)=>{const v=new FileReader;v.onload=()=>{const y=v.result;c(y.indexOf(",")>=0?y.split(",")[1]:y)},v.onerror=y=>S(y),v.readAsDataURL(s)})});return function(c){return p.apply(this,arguments)}}();class ut extends V{request(s){return(0,h.A)(function*(){const c=((p,s={})=>{const c=Object.assign({method:p.method||"GET",headers:p.headers},s),v=((p={})=>{const s=Object.keys(p);return Object.keys(p).map(v=>v.toLocaleLowerCase()).reduce((v,y,A)=>(v[y]=p[s[A]],v),{})})(p.headers)["content-type"]||"";if("string"==typeof p.data)c.body=p.data;else if(v.includes("application/x-www-form-urlencoded")){const y=new URLSearchParams;for(const[A,_]of Object.entries(p.data||{}))y.set(A,_);c.body=y.toString()}else if(v.includes("multipart/form-data")||p.data instanceof FormData){const y=new FormData;if(p.data instanceof FormData)p.data.forEach((_,O)=>{y.append(O,_)});else for(const _ of Object.keys(p.data))y.append(_,p.data[_]);c.body=y;const A=new Headers(c.headers);A.delete("content-type"),c.headers=A}else(v.includes("application/json")||"object"==typeof p.data)&&(c.body=JSON.stringify(p.data));return c})(s,s.webFetchExtra),S=((p,s=!0)=>p?Object.entries(p).reduce((S,v)=>{const[y,A]=v;let _,O;return Array.isArray(A)?(O="",A.forEach(w=>{_=s?encodeURIComponent(w):w,O+=`${y}=${_}&`}),O.slice(0,-1)):(_=s?encodeURIComponent(A):A,O=`${y}=${_}`),`${S}&${O}`},"").substr(1):null)(s.params,s.shouldEncodeUrlParams),v=S?`${s.url}?${S}`:s.url,y=yield fetch(v,c),A=y.headers.get("content-type")||"";let O,w,{responseType:_="text"}=y.ok?s:{};switch(A.includes("application/json")&&(_="json"),_){case"arraybuffer":case"blob":w=yield y.blob(),O=yield X(w);break;case"json":O=yield y.json();break;default:O=yield y.text()}const x={};return y.headers.forEach((F,k)=>{x[k]=F}),{data:O,headers:x,status:y.status,url:y.url}})()}get(s){var c=this;return(0,h.A)(function*(){return c.request(Object.assign(Object.assign({},s),{method:"GET"}))})()}post(s){var c=this;return(0,h.A)(function*(){return c.request(Object.assign(Object.assign({},s),{method:"POST"}))})()}put(s){var c=this;return(0,h.A)(function*(){return c.request(Object.assign(Object.assign({},s),{method:"PUT"}))})()}patch(s){var c=this;return(0,h.A)(function*(){return c.request(Object.assign(Object.assign({},s),{method:"PATCH"}))})()}delete(s){var c=this;return(0,h.A)(function*(){return c.request(Object.assign(Object.assign({},s),{method:"DELETE"}))})()}}Z("CapacitorHttp",{web:()=>new ut})},4772:(bt,st,E)=>{E.r(st),E.d(st,{HomePage:()=>Mt});var h=E(3308),T=E(7829),M=E(8211),H=E(5981),at=E(199),pt=E(8503),q=E(2029);class Z extends q.yU{constructor(a,r){super()}schedule(a,r=0){return this}}const V={setInterval(u,a,...r){const{delegate:t}=V;return t?.setInterval?t.setInterval(u,a,...r):setInterval(u,a,...r)},clearInterval(u){const{delegate:a}=V;return(a?.clearInterval||clearInterval)(u)},delegate:void 0};var yt=E(9583);const Q={now:()=>(Q.delegate||Date).now(),delegate:void 0};class Y{constructor(a,r=Y.now){this.schedulerActionCtor=a,this.now=r}schedule(a,r=0,t){return new this.schedulerActionCtor(this,a).schedule(t,r)}}Y.now=Q.now;const X=new class mt extends Y{constructor(a,r=Y.now){super(a,r),this.actions=[],this._active=!1}flush(a){const{actions:r}=this;if(this._active)return void r.push(a);let t;this._active=!0;do{if(t=a.execute(a.state,a.delay))break}while(a=r.shift());if(this._active=!1,t){for(;a=r.shift();)a.unsubscribe();throw t}}}(class rt extends Z{constructor(a,r){super(a,r),this.scheduler=a,this.work=r,this.pending=!1}schedule(a,r=0){var t;if(this.closed)return this;this.state=a;const n=this.id,i=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(i,n,r)),this.pending=!0,this.delay=r,this.id=null!==(t=this.id)&&void 0!==t?t:this.requestAsyncId(i,this.id,r),this}requestAsyncId(a,r,t=0){return V.setInterval(a.flush.bind(a,this),t)}recycleAsyncId(a,r,t=0){if(null!=t&&this.delay===t&&!1===this.pending)return r;null!=r&&V.clearInterval(r)}execute(a,r){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;const t=this._execute(a,r);if(t)return t;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(a,r){let n,t=!1;try{this.work(a)}catch(i){t=!0,n=i||new Error("Scheduled action threw falsy error")}if(t)return this.unsubscribe(),n}unsubscribe(){if(!this.closed){const{id:a,scheduler:r}=this,{actions:t}=r;this.work=this.state=this.scheduler=null,this.pending=!1,(0,yt.o)(t,this),null!=a&&(this.id=this.recycleAsyncId(r,a,null)),this.delay=null,super.unsubscribe()}}}),ct=X;var tt=E(9867),J=E(6111);const s=(0,E(2126).F3)("BackgroundGeofence",{web:()=>E.e(7572).then(E.bind(E,7572)).then(u=>new u.BackgroundGeofenceWeb)});var c=E(656);let S=(()=>{var u;class a{constructor(){this.MAX_ANDROID_REGIONS=100,this.MAX_IOS_REGIONS=20,this.OPTIMIZATION_RADIUS=1e4,this.HIGH_PRIORITY_RADIUS=2e3,this.MEDIUM_PRIORITY_RADIUS=5e3,this.currentLocation=new H.t(null),this.activeRegions=new H.t([]),this.stats=new H.t({activeRegions:0,maxRegions:this.getMaxRegions(),nearbyStations:0,totalStations:0,lastOptimization:null}),this.allStations=[],this.regionStorage=new Map,this.loadStoredRegions()}initialize(t){var n=this;return(0,h.A)(function*(){n.allStations=t,n.updateStats({totalStations:t.length}),console.log(`GeofenceManager initialized with ${t.length} stations`)})()}updateLocation(t,n){var i=this;return(0,h.A)(function*(){const o={latitude:t,longitude:n},d=i.currentLocation.value;i.currentLocation.next(o),!(d&&i.calculateDistance(d.latitude,d.longitude,t,n)<1e3)&&(yield i.optimizeGeofenceRegions(o))})()}optimizeGeofenceRegions(t){var n=this;return(0,h.A)(function*(){try{console.log("Optimizing geofence regions...");const i=n.allStations.map(l=>({station:l,distance:n.calculateDistance(t.latitude,t.longitude,l.latitude,l.longitude)})).filter(l=>l.distance<=n.OPTIMIZATION_RADIUS).sort((l,m)=>l.distance-m.distance);n.updateStats({nearbyStations:i.length});const o=n.prioritizeStations(i,t),d=n.getMaxRegions(),g=o.slice(0,d).map((l,m)=>{const b=l.station,D=n.calculateOptimalRadius(b,l.distance);return{identifier:`station-${b.id}`,latitude:b.latitude,longitude:b.longitude,radius:D,notifyOnEntry:!0,notifyOnExit:!0,data:{stationId:b.id,stationName:b.name,line:b.line,priority:l.priority},station:b,priority:l.priority,lastUpdated:new Date,distanceFromUser:l.distance}});yield n.updateActiveRegions(g),n.updateStats({activeRegions:g.length,lastOptimization:new Date}),console.log(`Optimized to ${g.length} geofence regions`)}catch(i){console.error("Failed to optimize geofence regions:",i)}})()}prioritizeStations(t,n){return t.map(i=>{let o=0;const d=i.distance;o+=d<=500?100:d<=1e3?80:d<=2e3?60:d<=5e3?40:20;const f=i.station.line?.toLowerCase()||"";f.includes("\u5c71\u624b")||f.includes("yamanote")?o+=30:f.includes("\u4e2d\u592e")||f.includes("\u7dcf\u6b66")?o+=25:f.includes("\u4eac\u6d5c\u6771\u5317")?o+=20:f.includes("\u6771\u6d77\u9053")?o+=15:o+=10;const g=i.station.name?.toLowerCase()||"";return(g.includes("\u65b0\u5bbf")||g.includes("\u6771\u4eac")||g.includes("\u6e0b\u8c37")||g.includes("\u54c1\u5ddd"))&&(o+=25),{...i,priority:o}}).sort((i,o)=>o.priority-i.priority)}calculateOptimalRadius(t,n){try{const i=JSON.parse(t.polygon_data);if("Polygon"===i.type&&i.coordinates&&i.coordinates[0]){const o=i.coordinates[0];let d=o[0][1],f=o[0][1],g=o[0][0],l=o[0][0];for(const P of o)d=Math.min(d,P[1]),f=Math.max(f,P[1]),g=Math.min(g,P[0]),l=Math.max(l,P[0]);const m=this.calculateDistance(d,t.longitude,f,t.longitude),b=this.calculateDistance(t.latitude,g,t.latitude,l),D=Math.max(m,b)/2;return Math.max(D+30,50)}}catch{}return n<=500?80:n<=1e3?100:n<=2e3?120:n<=5e3?150:200}updateActiveRegions(t){var n=this;return(0,h.A)(function*(){const i=n.activeRegions.value,o=new Set(i.map(l=>l.identifier)),d=new Set(t.map(l=>l.identifier)),f=i.filter(l=>!d.has(l.identifier)),g=t.filter(l=>!o.has(l.identifier));if(f.length>0){const l=f.map(m=>m.identifier);yield s.removeGeofences({identifiers:l}),console.log(`Removed ${f.length} geofence regions`)}if(g.length>0){const l=g.map(m=>({identifier:m.identifier,latitude:m.latitude,longitude:m.longitude,radius:m.radius,notifyOnEntry:m.notifyOnEntry,notifyOnExit:m.notifyOnExit,data:m.data}));yield s.addGeofences({geofences:l}),console.log(`Added ${g.length} geofence regions`)}n.activeRegions.next(t),n.saveRegionsToStorage(t)})()}getMaxRegions(){return this.MAX_IOS_REGIONS}calculateDistance(t,n,i,o){const f=t*Math.PI/180,g=i*Math.PI/180,l=(i-t)*Math.PI/180,m=(o-n)*Math.PI/180,b=Math.sin(l/2)*Math.sin(l/2)+Math.cos(f)*Math.cos(g)*Math.sin(m/2)*Math.sin(m/2);return 2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b))*6371e3}saveRegionsToStorage(t){const n=t.map(i=>({identifier:i.identifier,latitude:i.latitude,longitude:i.longitude,radius:i.radius,stationId:i.station.id,priority:i.priority,lastUpdated:i.lastUpdated.toISOString()}));localStorage.setItem("geofence_regions",JSON.stringify(n))}loadStoredRegions(){try{const t=localStorage.getItem("geofence_regions");if(t){const n=JSON.parse(t);console.log(`Loaded ${n.length} stored geofence regions`)}}catch(t){console.error("Failed to load stored regions:",t)}}updateStats(t){this.stats.next({...this.stats.value,...t})}getCurrentLocation(){return this.currentLocation.asObservable()}getActiveRegions(){return this.activeRegions.asObservable()}getStats(){return this.stats.asObservable()}forceOptimization(){var t=this;return(0,h.A)(function*(){const n=t.currentLocation.value;n&&(yield t.optimizeGeofenceRegions(n))})()}clearAllRegions(){var t=this;return(0,h.A)(function*(){const n=t.activeRegions.value;if(n.length>0){const i=n.map(o=>o.identifier);yield s.removeGeofences({identifiers:i}),t.activeRegions.next([]),localStorage.removeItem("geofence_regions"),t.updateStats({activeRegions:0,lastOptimization:new Date})}})()}static#t=u=()=>(this.\u0275fac=function(n){return new(n||a)},this.\u0275prov=c.jDH({token:a,factory:a.\u0275fac,providedIn:"root"}))}return u(),a})();var v=E(9406),y=E(1677);function A(u){return u instanceof Date&&!isNaN(u)}function _(u=0,a,r=ct){let t=-1;return null!=a&&((0,y.m)(a)?r=a:t=a),new v.c(n=>{let i=A(u)?+u-r.now():u;i<0&&(i=0);let o=0;return r.schedule(function(){n.closed||(n.next(o++),0<=t?this.schedule(void 0,t):n.complete())},i)})}function O(u=0,a=X){return u<0&&(u=0),_(u,u,a)}let w=(()=>{var u;class a{constructor(){this.locationHistory=[],this.movementPattern=new H.t(null),this.optimizationMetrics=new H.t({hitRate:0,falsePositiveRate:0,batteryScore:100,regionCount:0,lastOptimization:new Date}),this.MAX_LOCATION_HISTORY=1e3,this.OPTIMIZATION_INTERVAL=3e5,this.loadLocationHistory(),this.startPeriodicOptimization()}updateLocation(t){this.locationHistory.unshift(t),this.locationHistory.length>this.MAX_LOCATION_HISTORY&&(this.locationHistory=this.locationHistory.slice(0,this.MAX_LOCATION_HISTORY)),this.saveLocationHistory(),this.analyzeMovementPattern()}analyzeMovementPattern(){if(this.locationHistory.length<10)return;const t=this.locationHistory.slice(0,50);let n=0,i=0;for(let G=1;G<t.length;G++){const gt=t[G-1],ft=t[G],Ot=this.calculateDistance(gt.latitude,gt.longitude,ft.latitude,ft.longitude),ht=(gt.timestamp.getTime()-ft.timestamp.getTime())/1e3;if(ht>0&&ht<600){const St=Ot/ht;St<50&&(n+=St,i++)}}const o=i>0?n/i:0,d=this.calculatePrimaryDirection(t),f=this.findFrequentAreas(this.locationHistory),g=new Date,l=g.getHours(),m=l<6?"night":l<12?"morning":l<18?"afternoon":"evening",b=g.getDay();this.movementPattern.next({averageSpeed:o,primaryDirection:d,frequentAreas:f,timeOfDay:m,dayType:0===b||6===b?"weekend":"weekday"})}calculatePrimaryDirection(t){if(t.length<5)return 0;let n=0,i=0;for(let d=1;d<Math.min(t.length,20);d++)n+=t[d-1].latitude-t[d].latitude,i+=t[d-1].longitude-t[d].longitude;return(180*Math.atan2(n,i)/Math.PI+360)%360}findFrequentAreas(t){const i=new Map;for(const o of t){const d=.001*Math.round(o.latitude/.001),f=.001*Math.round(o.longitude/.001),g=`${d},${f}`;i.has(g)?i.get(g).visits++:i.set(g,{lat:d,lng:f,visits:1})}return Array.from(i.values()).filter(o=>o.visits>=5).sort((o,d)=>d.visits-o.visits).slice(0,10)}optimizeGeofenceSelection(t,n,i){const o=this.movementPattern.value,d=t.map(l=>({...l,score:this.calculateStationScore(l,n,o)})).sort((l,m)=>m.score-l.score);return this.applyContextFiltering(d,o).slice(0,i).map((l,m)=>{const b=this.calculateDynamicRadius(l,o);return{identifier:`station-${l.station.id}`,latitude:l.station.latitude,longitude:l.station.longitude,radius:b,notifyOnEntry:!0,notifyOnExit:!0,data:{stationId:l.station.id,stationName:l.station.name,line:l.station.line,score:l.score,optimized:!0},station:l.station,priority:Math.round(l.score),lastUpdated:new Date,distanceFromUser:l.distance}})}calculateStationScore(t,n,i){let o=0;if(o+=.4*Math.max(0,(1e4-t.distance)/1e4*100),i){const l=this.calculateBearing(n.latitude,n.longitude,t.station.latitude,t.station.longitude),m=Math.abs(l-i.primaryDirection);o+=.2*Math.max(0,(180-Math.min(m,360-m))/180*100)}i&&i.frequentAreas.length>0&&i.frequentAreas.some(m=>this.calculateDistance(t.station.latitude,t.station.longitude,m.lat,m.lng)<=500)&&(o+=30);const g=t.station.line?.toLowerCase()||"";if(g.includes("\u5c71\u624b")||g.includes("yamanote")?o+=25:g.includes("\u4e2d\u592e")||g.includes("\u7dcf\u6b66")?o+=20:g.includes("\u4eac\u6d5c\u6771\u5317")?o+=15:g.includes("\u6771\u6d77\u9053")&&(o+=10),i&&("morning"===i.timeOfDay||"evening"===i.timeOfDay)&&"weekday"===i.dayType){const l=t.station.name?.toLowerCase()||"";(l.includes("\u65b0\u5bbf")||l.includes("\u6771\u4eac")||l.includes("\u6e0b\u8c37")||l.includes("\u54c1\u5ddd"))&&(o+=20)}return i&&i.averageSpeed>10&&(o+=10),Math.round(o)}applyContextFiltering(t,n){return n?n.averageSpeed>20?t.filter(i=>i.score>=50).slice(0,Math.floor(.7*t.length)):n.averageSpeed<2?t.filter(i=>i.distance<=2e3):t:t}calculateDynamicRadius(t,n){let i=100;t.distance>5e3?i=150:t.distance>2e3?i=120:t.distance<500&&(i=80),n&&(n.averageSpeed>15?i+=50:n.averageSpeed<1&&(i-=20));try{const o=JSON.parse(t.station.polygon_data);if("Polygon"===o.type&&o.coordinates&&o.coordinates[0]){const d=o.coordinates[0];let f=d[0][1],g=d[0][1],l=d[0][0],m=d[0][0];for(const G of d)f=Math.min(f,G[1]),g=Math.max(g,G[1]),l=Math.min(l,G[0]),m=Math.max(m,G[0]);const b=this.calculateDistance(f,t.station.longitude,g,t.station.longitude),D=this.calculateDistance(t.station.latitude,l,t.station.latitude,m),P=Math.max(b,D)/2;i=Math.max(i,P+30)}}catch{}return Math.max(i,50)}startPeriodicOptimization(){this.optimizationSubscription=O(this.OPTIMIZATION_INTERVAL).subscribe(()=>{this.analyzeMovementPattern()})}calculateBearing(t,n,i,o){const d=(o-n)*Math.PI/180,f=t*Math.PI/180,g=i*Math.PI/180,l=Math.sin(d)*Math.cos(g),m=Math.cos(f)*Math.sin(g)-Math.sin(f)*Math.cos(g)*Math.cos(d);return(180*Math.atan2(l,m)/Math.PI+360)%360}calculateDistance(t,n,i,o){const f=t*Math.PI/180,g=i*Math.PI/180,l=(i-t)*Math.PI/180,m=(o-n)*Math.PI/180,b=Math.sin(l/2)*Math.sin(l/2)+Math.cos(f)*Math.cos(g)*Math.sin(m/2)*Math.sin(m/2);return 2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b))*6371e3}saveLocationHistory(){try{const n=this.locationHistory.slice(0,200).map(i=>({...i,timestamp:i.timestamp.toISOString()}));localStorage.setItem("location_history",JSON.stringify(n))}catch(t){console.error("Failed to save location history:",t)}}loadLocationHistory(){try{const t=localStorage.getItem("location_history");if(t){const n=JSON.parse(t);this.locationHistory=n.map(i=>({...i,timestamp:new Date(i.timestamp)})),console.log(`Loaded ${this.locationHistory.length} location history entries`)}}catch(t){console.error("Failed to load location history:",t)}}getMovementPattern(){return this.movementPattern.asObservable()}getOptimizationMetrics(){return this.optimizationMetrics.asObservable()}destroy(){this.optimizationSubscription&&this.optimizationSubscription.unsubscribe()}static#t=u=()=>(this.\u0275fac=function(n){return new(n||a)},this.\u0275prov=c.jDH({token:a,factory:a.\u0275fac,providedIn:"root"}))}return u(),a})();var x=E(65),F=E(8621),k=E(4520),W=E(1982);const N=(0,k.L)(u=>function(r=null){u(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=r});function $(u,a){const{first:r,each:t,with:n=z,scheduler:i=a??X,meta:o=null}=A(u)?{first:u}:"number"==typeof u?{each:u}:u;if(null==r&&null==t)throw new TypeError("No timeout provided.");return(0,tt.N)((d,f)=>{let g,l,m=null,b=0;const D=P=>{l=(0,W.N)(f,i,()=>{try{g.unsubscribe(),(0,F.Tg)(n({meta:o,lastValue:m,seen:b})).subscribe(f)}catch(G){f.error(G)}},P)};g=d.subscribe((0,J._)(f,P=>{l?.unsubscribe(),b++,f.next(m=P),t>0&&D(t)},void 0,void 0,()=>{l?.closed||l?.unsubscribe(),m=null})),!b&&D(null!=r?"number"==typeof r?r:+r-i.now():t)})}function z(u){throw new N(u)}var lt=E(9656);function et(u=1/0){let a;a=u&&"object"==typeof u?u:{count:u};const{count:r=1/0,delay:t,resetOnSuccess:n=!1}=a;return r<=0?lt.D:(0,tt.N)((i,o)=>{let f,d=0;const g=()=>{let l=!1;f=i.subscribe((0,J._)(o,m=>{n&&(d=0),o.next(m)},void 0,m=>{if(d++<r){const b=()=>{f?(f.unsubscribe(),f=null,g()):l=!0};if(null!=t){const D="number"==typeof t?_(t):(0,F.Tg)(t(m,d)),P=(0,J._)(o,()=>{P.unsubscribe(),b()},()=>{o.complete()});D.subscribe(P)}else b()}else o.error(m)})),l&&(f.unsubscribe(),f=null,g())};g()})}var nt=E(4526);let it=(()=>{var u;class a{constructor(t){this.http=t,this.API_BASE_URL="https://api.station-tracker.com",this.SYNC_INTERVAL=3e4,this.MAX_BATCH_SIZE=50,this.RETRY_ATTEMPTS=3,this.OFFLINE_STORAGE_KEY="pending_geofence_events",this.syncStatus=new H.t({isOnline:navigator.onLine,lastSync:null,pendingEvents:0,syncErrors:0,totalEventsSynced:0}),this.pendingEvents=[],this.deviceId=this.getOrCreateDeviceId(),this.loadPendingEvents(),this.setupNetworkListeners(),this.startPeriodicSync()}queueGeofenceEvent(t){var n=this;return(0,h.A)(function*(){const i={stationId:t.data?.stationId||0,stationName:t.data?.stationName||"Unknown",line:t.data?.line||"Unknown",eventType:t.action,latitude:t.latitude,longitude:t.longitude,timestamp:new Date(t.timestamp).toISOString(),deviceId:n.deviceId,appVersion:"1.0.0",synced:!1,localTimestamp:(new Date).toISOString()};n.pendingEvents.push(i),n.updateSyncStatus({pendingEvents:n.pendingEvents.length}),n.savePendingEvents(),navigator.onLine&&n.performSync(),console.log("Queued geofence event for sync:",i)})()}performSync(){var t=this;return(0,h.A)(function*(){if(0===t.pendingEvents.length)return;const n=t.syncStatus.value;try{const i=Math.min(t.MAX_BATCH_SIZE,t.pendingEvents.length),o=t.pendingEvents.slice(0,i);console.log(`Syncing batch of ${o.length} events...`);const d=new x.Lr({"Content-Type":"application/json",Authorization:`Bearer ${yield t.getAuthToken()}`}),f=yield t.http.post(`${t.API_BASE_URL}/geofence-events`,{events:o},{headers:d}).pipe($(3e4),et(t.RETRY_ATTEMPTS),(0,nt.W)(g=>{throw console.error("Sync failed:",g),g})).toPromise();if(!f?.success)throw new Error(f?.error||"Sync failed");t.pendingEvents.splice(0,i),t.updateSyncStatus({lastSync:new Date,pendingEvents:t.pendingEvents.length,totalEventsSynced:n.totalEventsSynced+i,syncErrors:Math.max(0,n.syncErrors-1)}),t.savePendingEvents(),console.log(`Successfully synced ${i} events`),t.pendingEvents.length>0&&setTimeout(()=>t.performSync(),1e3)}catch(i){console.error("Failed to sync geofence events:",i),t.updateSyncStatus({syncErrors:n.syncErrors+1});const o=Math.min(3e5,1e3*Math.pow(2,n.syncErrors));setTimeout(()=>{navigator.onLine&&t.performSync()},o)}})()}getAuthToken(){return(0,h.A)(function*(){return localStorage.getItem("auth_token")||"anonymous"})()}setupNetworkListeners(){window.addEventListener("online",()=>{console.log("Network back online, resuming sync..."),this.updateSyncStatus({isOnline:!0}),this.performSync()}),window.addEventListener("offline",()=>{console.log("Network offline, queueing events..."),this.updateSyncStatus({isOnline:!1})})}startPeriodicSync(){this.syncSubscription=O(this.SYNC_INTERVAL).subscribe(()=>{navigator.onLine&&this.pendingEvents.length>0&&this.performSync()})}getOrCreateDeviceId(){let t=localStorage.getItem("device_id");return t||(t="device_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("device_id",t)),t}savePendingEvents(){try{localStorage.setItem(this.OFFLINE_STORAGE_KEY,JSON.stringify(this.pendingEvents))}catch(t){console.error("Failed to save pending events:",t)}}loadPendingEvents(){try{const t=localStorage.getItem(this.OFFLINE_STORAGE_KEY);t&&(this.pendingEvents=JSON.parse(t),this.updateSyncStatus({pendingEvents:this.pendingEvents.length}),console.log(`Loaded ${this.pendingEvents.length} pending events from storage`))}catch(t){console.error("Failed to load pending events:",t),this.pendingEvents=[]}}updateSyncStatus(t){this.syncStatus.next({...this.syncStatus.value,...t})}forcSync(){var t=this;return(0,h.A)(function*(){if(!navigator.onLine)throw new Error("Device is offline");yield t.performSync()})()}getSyncStats(){return this.syncStatus.value}clearPendingEvents(){this.pendingEvents=[],this.updateSyncStatus({pendingEvents:0}),localStorage.removeItem(this.OFFLINE_STORAGE_KEY),console.log("Cleared all pending events")}syncStationVisit(t){var n=this;return(0,h.A)(function*(){try{const i=new x.Lr({"Content-Type":"application/json",Authorization:`Bearer ${yield n.getAuthToken()}`}),o=yield n.http.post(`${n.API_BASE_URL}/station-visits`,{...t,deviceId:n.deviceId},{headers:i}).pipe($(15e3),et(2)).toPromise();if(!o?.success)throw new Error(o?.error||"Failed to sync station visit");console.log("Station visit synced successfully")}catch(i){console.error("Failed to sync station visit:",i)}})()}fetchServerConfig(){var t=this;return(0,h.A)(function*(){try{const n=new x.Lr({Authorization:`Bearer ${yield t.getAuthToken()}`}),i=yield t.http.get(`${t.API_BASE_URL}/config`,{headers:n}).pipe($(1e4),et(1)).toPromise();if(i?.success&&i.data)return console.log("Server config updated:",i.data),i.data}catch(n){console.error("Failed to fetch server config:",n)}return null})()}reportAnalytics(t,n){var i=this;return(0,h.A)(function*(){try{const o={event:t,data:n,deviceId:i.deviceId,timestamp:(new Date).toISOString(),appVersion:"1.0.0"};i.http.post(`${i.API_BASE_URL}/analytics`,o,{headers:new x.Lr({"Content-Type":"application/json"})}).subscribe({next:()=>console.log("Analytics reported"),error:d=>console.warn("Analytics failed:",d)})}catch(o){console.warn("Analytics error:",o)}})()}getSyncStatus(){return this.syncStatus.asObservable()}destroy(){this.syncSubscription&&this.syncSubscription.unsubscribe()}static#t=u=()=>(this.\u0275fac=function(n){return new(n||a)(c.KVO(x.Qq))},this.\u0275prov=c.jDH({token:a,factory:a.\u0275fac,providedIn:"root"}))}return u(),a})();var ot=E(334);let dt=(()=>{var u;class a{constructor(t,n,i,o){this.geofenceManager=t,this.optimizer=n,this.cloudSync=i,this.stationService=o,this.trackingStatus=new H.t({isActive:!1,nativeGeofencing:!1,jsGeofencing:!1,backgroundMode:!1,cloudSync:!1,activeRegions:0,lastLocationUpdate:null,batteryOptimized:!0}),this.configuration={useNativeGeofencing:!0,useFallbackJS:!0,enableCloudSync:!0,optimizationLevel:"balanced",syncInterval:3e4,maxRegions:20},this.subscriptions=[],this.stations=[],this.isInitialized=!1,this.setupSubscriptions(),this.loadConfiguration()}initialize(){var t=this;return(0,h.A)(function*(){if(!t.isInitialized)try{console.log("Initializing integrated geofence system..."),t.stations=(yield t.stationService.getAllStations().toPromise())||[],console.log(`Loaded ${t.stations.length} stations`),yield t.geofenceManager.initialize(t.stations),t.setupNativeListeners(),yield t.updateConfigurationForDevice(),t.isInitialized=!0,console.log("Integrated geofence system initialized successfully")}catch(n){throw console.error("Failed to initialize integrated geofence system:",n),n}})()}startTracking(){var t=this;return(0,h.A)(function*(){t.isInitialized||(yield t.initialize());try{console.log("Starting integrated geofence tracking...");let n=!1,i=!1;if(t.configuration.useNativeGeofencing)try{"granted"===(yield s.checkPermissions()).backgroundLocation?(yield s.startGeofencing({enableHighAccuracy:"accuracy"===t.configuration.optimizationLevel,notification:{title:"\u99c5\u8a18\u9332\u30a2\u30d7\u30ea",text:"\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u99c5\u3078\u306e\u5230\u7740\u30fb\u51fa\u767a\u3092\u8a18\u9332\u4e2d..."},distanceFilter:t.getDistanceFilterForOptimization(),interval:t.configuration.syncInterval}),n=!0,console.log("Native geofencing started successfully")):(console.warn("Background location permission not granted, requesting..."),"granted"===(yield s.requestPermissions()).backgroundLocation&&(yield s.startGeofencing({enableHighAccuracy:"accuracy"===t.configuration.optimizationLevel,notification:{title:"\u99c5\u8a18\u9332\u30a2\u30d7\u30ea",text:"\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u99c5\u3078\u306e\u5230\u7740\u30fb\u51fa\u767a\u3092\u8a18\u9332\u4e2d..."}}),n=!0))}catch(d){console.error("Native geofencing failed to start:",d)}!n&&t.configuration.useFallbackJS&&(i=yield t.startJSGeofencing());const o=n||i;return t.updateTrackingStatus({isActive:o,nativeGeofencing:n,jsGeofencing:i,backgroundMode:n,cloudSync:t.configuration.enableCloudSync}),o&&(yield t.cloudSync.reportAnalytics("tracking_started",{native:n,fallback:i,configuration:t.configuration})),o}catch(n){return console.error("Failed to start integrated tracking:",n),t.updateTrackingStatus({isActive:!1}),!1}})()}stopTracking(){var t=this;return(0,h.A)(function*(){try{console.log("Stopping integrated geofence tracking..."),t.trackingStatus.value.nativeGeofencing&&(yield s.stopGeofencing()),t.trackingStatus.value.jsGeofencing&&(yield t.stopJSGeofencing()),t.updateTrackingStatus({isActive:!1,nativeGeofencing:!1,jsGeofencing:!1,backgroundMode:!1,activeRegions:0}),yield t.cloudSync.reportAnalytics("tracking_stopped",{reason:"user_requested"})}catch(n){console.error("Failed to stop tracking:",n)}})()}updateLocation(t,n){var i=this;return(0,h.A)(function*(o,d,f=10){i.isInitialized&&(i.optimizer.updateLocation({latitude:o,longitude:d,accuracy:f,timestamp:new Date}),yield i.geofenceManager.updateLocation(o,d),i.updateTrackingStatus({lastLocationUpdate:new Date}))}).apply(this,arguments)}setupNativeListeners(){var t=this;s.addListener("geofenceEvent",function(){var n=(0,h.A)(function*(i){console.log("Native geofence event received:",i),yield t.handleGeofenceEvent(i),t.configuration.enableCloudSync&&(yield t.cloudSync.queueGeofenceEvent(i))});return function(i){return n.apply(this,arguments)}}()),s.addListener("locationUpdate",n=>{this.updateLocation(n.latitude,n.longitude,n.accuracy)})}setupSubscriptions(){this.subscriptions.push(this.geofenceManager.getStats().subscribe(t=>{this.updateTrackingStatus({activeRegions:t.activeRegions,batteryOptimized:t.activeRegions<=t.maxRegions})})),this.subscriptions.push(this.cloudSync.getSyncStatus().subscribe(t=>{this.updateTrackingStatus({cloudSync:t.isOnline&&t.syncErrors<5})})),this.subscriptions.push((0,at.z)([this.geofenceManager.getCurrentLocation(),this.optimizer.getMovementPattern()]).pipe((0,pt.p)(([t,n])=>null!==t),function ut(u,a=X){return(0,tt.N)((r,t)=>{let n=null,i=null,o=null;const d=()=>{if(n){n.unsubscribe(),n=null;const g=i;i=null,t.next(g)}};function f(){const g=o+u,l=a.now();if(l<g)return n=this.schedule(void 0,g-l),void t.add(n);d()}r.subscribe((0,J._)(t,g=>{i=g,o=a.now(),n||(n=a.schedule(f,u),t.add(n))},()=>{d(),t.complete()},void 0,()=>{i=n=null}))})}(3e4)).subscribe(([t,n])=>{t&&this.trackingStatus.value.isActive&&this.performIntelligentOptimization(t,n)}))}performIntelligentOptimization(t,n){var i=this;return(0,h.A)(function*(){try{if("battery"===i.configuration.optimizationLevel&&n)if(n.averageSpeed<1)yield i.geofenceManager.updateLocation(t.latitude,t.longitude);else if(n.averageSpeed>20){const o=yield i.geofenceManager.getStats().pipe().toPromise();o&&o.activeRegions>10&&(yield i.geofenceManager.forceOptimization())}}catch(o){console.error("Intelligent optimization failed:",o)}})()}handleGeofenceEvent(t){var n=this;return(0,h.A)(function*(){try{console.log("Processing geofence event:",t);const i=t.data?.stationId,o=n.stations.find(d=>d.id===i);if(o&&"enter"===t.action){const d={station:o.id,arrived_at:new Date(t.timestamp).toISOString(),latitude:t.latitude,longitude:t.longitude,weather:yield n.getCurrentWeather({latitude:t.latitude,longitude:t.longitude})};try{yield n.stationService.createVisit(d).toPromise(),console.log(`Recorded visit to ${o.name}`),n.configuration.enableCloudSync&&(yield n.cloudSync.syncStationVisit(d))}catch(f){console.error("Failed to record station visit:",f)}}yield n.cloudSync.reportAnalytics("geofence_event",{stationId:i,stationName:o?.name,eventType:t.action,source:"native"})}catch(i){console.error("Failed to handle geofence event:",i)}})()}startJSGeofencing(){return(0,h.A)(function*(){return console.log("Starting JS fallback geofencing..."),!0})()}stopJSGeofencing(){return(0,h.A)(function*(){console.log("Stopping JS fallback geofencing...")})()}updateConfigurationForDevice(){var t=this;return(0,h.A)(function*(){try{const n=yield s.checkPermissions();t.configuration.maxRegions=20,"granted"!==n.backgroundLocation&&(t.configuration.optimizationLevel="battery",t.configuration.useNativeGeofencing=!1),console.log("Updated configuration for device:",t.configuration)}catch(n){console.error("Failed to update device configuration:",n)}})()}getDistanceFilterForOptimization(){switch(this.configuration.optimizationLevel){case"accuracy":return 5;case"balanced":default:return 10;case"battery":return 25}}getCurrentWeather(t){return(0,h.A)(function*(){const n=["\u6674\u308c","\u66c7\u308a","\u96e8","\u96ea"];return n[Math.floor(Math.random()*n.length)]})()}loadConfiguration(){try{const t=localStorage.getItem("tracking_configuration");if(t){const n=JSON.parse(t);this.configuration={...this.configuration,...n},console.log("Loaded tracking configuration:",this.configuration)}}catch(t){console.error("Failed to load configuration:",t)}}saveConfiguration(){try{localStorage.setItem("tracking_configuration",JSON.stringify(this.configuration))}catch(t){console.error("Failed to save configuration:",t)}}updateTrackingStatus(t){this.trackingStatus.next({...this.trackingStatus.value,...t})}getTrackingStatus(){return this.trackingStatus.asObservable()}getCurrentConfiguration(){return{...this.configuration}}updateConfiguration(t){var n=this;return(0,h.A)(function*(){n.configuration={...n.configuration,...t},n.saveConfiguration(),n.trackingStatus.value.isActive&&(yield n.stopTracking(),yield n.startTracking())})()}getSystemStatus(){var t=this;return(0,h.A)(function*(){const n=yield t.geofenceManager.getStats().pipe().toPromise(),i=t.cloudSync.getSyncStats(),o=yield t.optimizer.getOptimizationMetrics().pipe().toPromise();return{tracking:t.trackingStatus.value,configuration:t.configuration,geofence:n,sync:i,optimization:o}})()}ngOnDestroy(){this.subscriptions.forEach(t=>t.unsubscribe()),this.optimizer.destroy(),this.cloudSync.destroy()}static#t=u=()=>(this.\u0275fac=function(n){return new(n||a)(c.KVO(S),c.KVO(w),c.KVO(it),c.KVO(ot.k))},this.\u0275prov=c.jDH({token:a,factory:a.\u0275fac,providedIn:"root"}))}return u(),a})();var e=E(4303);function I(u,a){1&u&&(e.j41(0,"ion-card")(1,"ion-card-content"),e.nrm(2,"ion-progress-bar",9),e.j41(3,"p"),e.EFF(4,"\u30b7\u30b9\u30c6\u30e0\u3092\u521d\u671f\u5316\u4e2d..."),e.k0s()()())}function C(u,a){if(1&u&&(e.j41(0,"div",10)(1,"ion-item",11)(2,"ion-label"),e.EFF(3,"\u30cd\u30a4\u30c6\u30a3\u30d6\u30b8\u30aa\u30d5\u30a7\u30f3\u30b9"),e.k0s(),e.j41(4,"ion-badge",12),e.EFF(5),e.k0s()(),e.j41(6,"ion-item",11)(7,"ion-label"),e.EFF(8,"\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u30e2\u30fc\u30c9"),e.k0s(),e.j41(9,"ion-badge",12),e.EFF(10),e.k0s()(),e.j41(11,"ion-item",11)(12,"ion-label"),e.EFF(13,"\u30af\u30e9\u30a6\u30c9\u540c\u671f"),e.k0s(),e.j41(14,"ion-badge",12),e.EFF(15),e.k0s()(),e.j41(16,"ion-item",11)(17,"ion-label"),e.EFF(18,"\u30a2\u30af\u30c6\u30a3\u30d6\u9818\u57df"),e.k0s(),e.j41(19,"ion-badge",13),e.EFF(20),e.k0s()()()),2&u){const r=e.XpG();e.R7$(4),e.Y8G("color",r.trackingStatus.nativeGeofencing?"success":"medium"),e.R7$(),e.SpI(" ",r.trackingStatus.nativeGeofencing?"ON":"OFF"," "),e.R7$(4),e.Y8G("color",r.trackingStatus.backgroundMode?"success":"medium"),e.R7$(),e.SpI(" ",r.trackingStatus.backgroundMode?"ON":"OFF"," "),e.R7$(4),e.Y8G("color",r.getSyncStatusColor()),e.R7$(),e.SpI(" ",r.syncStatus.isOnline?"\u30aa\u30f3\u30e9\u30a4\u30f3":"\u30aa\u30d5\u30e9\u30a4\u30f3"," "),e.R7$(5),e.Lme("",r.trackingStatus.activeRegions,"/",r.geofenceStats.maxRegions)}}function L(u,a){if(1&u&&(e.j41(0,"p"),e.EFF(1),e.nI1(2,"date"),e.k0s()),2&u){const r=e.XpG(2);e.R7$(),e.SpI(" \u6700\u7d42\u66f4\u65b0: ",e.i5U(2,1,r.trackingStatus.lastLocationUpdate,"HH:mm:ss")," ")}}function j(u,a){if(1&u&&(e.j41(0,"div",14)(1,"p"),e.EFF(2),e.nI1(3,"number"),e.nI1(4,"number"),e.k0s(),e.DNE(5,L,3,4,"p",4),e.k0s()),2&u){const r=e.XpG();e.R7$(2),e.Lme("\u73fe\u5728\u4f4d\u7f6e: ",e.i5U(3,3,r.currentLocation.latitude,"1.6-6"),", ",e.i5U(4,6,r.currentLocation.longitude,"1.6-6")),e.R7$(3),e.Y8G("ngIf",r.trackingStatus.lastLocationUpdate)}}function B(u,a){if(1&u&&(e.j41(0,"ion-item",11)(1,"ion-label")(2,"h3"),e.EFF(3,"\u6700\u7d42\u6700\u9069\u5316"),e.k0s(),e.j41(4,"p"),e.EFF(5),e.nI1(6,"date"),e.k0s()()()),2&u){const r=e.XpG(2);e.R7$(5),e.JRh(e.i5U(6,1,r.geofenceStats.lastOptimization,"MM/dd HH:mm"))}}function R(u,a){if(1&u&&(e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3,"\u30b7\u30b9\u30c6\u30e0\u7d71\u8a08"),e.k0s()(),e.j41(4,"ion-card-content")(5,"ion-item",11)(6,"ion-label")(7,"h3"),e.EFF(8,"\u30b8\u30aa\u30d5\u30a7\u30f3\u30b9\u9818\u57df"),e.k0s(),e.j41(9,"p"),e.EFF(10),e.k0s()(),e.j41(11,"ion-badge",12),e.EFF(12),e.k0s()(),e.j41(13,"ion-item",11)(14,"ion-label")(15,"h3"),e.EFF(16,"\u5468\u8fba\u99c5"),e.k0s(),e.j41(17,"p"),e.EFF(18),e.k0s()()(),e.j41(19,"ion-item",11)(20,"ion-label")(21,"h3"),e.EFF(22,"\u540c\u671f\u72b6\u6cc1"),e.k0s(),e.j41(23,"p"),e.EFF(24),e.k0s(),e.j41(25,"p"),e.EFF(26),e.k0s()(),e.j41(27,"ion-badge",12),e.EFF(28),e.k0s()(),e.DNE(29,B,7,4,"ion-item",15),e.k0s()()),2&u){const r=e.XpG();e.R7$(10),e.Lme("",r.geofenceStats.activeRegions," / ",r.geofenceStats.maxRegions," \u4f7f\u7528\u4e2d"),e.R7$(),e.Y8G("color",r.getBatteryOptimizationColor()),e.R7$(),e.SpI(" ",r.trackingStatus.batteryOptimized?"\u6700\u9069\u5316\u6e08\u307f":"\u8981\u6700\u9069\u5316"," "),e.R7$(6),e.Lme("",r.geofenceStats.nearbyStations," / ",r.geofenceStats.totalStations," \u99c5"),e.R7$(6),e.SpI("\u672a\u9001\u4fe1: ",r.syncStatus.pendingEvents,"\u4ef6"),e.R7$(2),e.SpI("\u30a8\u30e9\u30fc: ",r.syncStatus.syncErrors,"\u4ef6"),e.R7$(),e.Y8G("color",r.getSyncStatusColor()),e.R7$(),e.SpI(" ",r.syncStatus.totalEventsSynced,"\u4ef6\u540c\u671f\u6e08\u307f "),e.R7$(),e.Y8G("ngIf",r.geofenceStats.lastOptimization)}}function U(u,a){if(1&u){const r=e.RV6();e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3,"\u624b\u52d5\u64cd\u4f5c"),e.k0s()(),e.j41(4,"ion-card-content")(5,"ion-button",16),e.bIt("click",function(){c.eBV(r);const n=e.XpG();return c.Njj(n.forceOptimization())}),e.EFF(6," \u30b8\u30aa\u30d5\u30a7\u30f3\u30b9\u6700\u9069\u5316\u5b9f\u884c "),e.k0s(),e.j41(7,"ion-button",17),e.bIt("click",function(){c.eBV(r);const n=e.XpG();return c.Njj(n.forcSync())}),e.EFF(8," \u30af\u30e9\u30a6\u30c9\u540c\u671f\u5b9f\u884c "),e.k0s(),e.j41(9,"ion-button",16),e.bIt("click",function(){c.eBV(r);const n=e.XpG();return c.Njj(n.getSystemStatus())}),e.EFF(10," \u30b7\u30b9\u30c6\u30e0\u72b6\u6cc1\u8868\u793a\uff08\u30b3\u30f3\u30bd\u30fc\u30eb\uff09 "),e.k0s()()()}if(2&u){const r=e.XpG();e.R7$(7),e.Y8G("disabled",!r.syncStatus.isOnline)}}function K(u,a){if(1&u&&(e.j41(0,"p"),e.EFF(1),e.k0s()),2&u){const r=e.XpG().$implicit,t=e.XpG(2);e.R7$(),e.SpI("",t.calculateDistance(r),"m")}}function Et(u,a){if(1&u&&(e.j41(0,"ion-item")(1,"ion-label")(2,"h3"),e.EFF(3),e.k0s(),e.j41(4,"p"),e.EFF(5),e.k0s(),e.DNE(6,K,2,1,"p",4),e.k0s()()),2&u){const r=a.$implicit,t=e.XpG(2);e.R7$(3),e.JRh(r.name),e.R7$(2),e.JRh(r.line),e.R7$(),e.Y8G("ngIf",t.calculateDistance(r))}}function At(u,a){if(1&u&&(e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3),e.k0s()(),e.j41(4,"ion-card-content")(5,"ion-list"),e.DNE(6,Et,7,3,"ion-item",18),e.k0s()()()),2&u){const r=e.XpG();e.R7$(3),e.SpI("\u5468\u8fba\u306e\u99c5 (",r.nearbyStations.length,"\u4ef6)"),e.R7$(3),e.Y8G("ngForOf",r.nearbyStations.slice(0,10))}}function Ft(u,a){if(1&u&&(e.j41(0,"p"),e.EFF(1),e.nI1(2,"date"),e.k0s()),2&u){const r=e.XpG().$implicit;e.R7$(),e.SpI("\u51fa\u767a: ",e.i5U(2,1,r.departed_at,"HH:mm:ss"))}}function _t(u,a){if(1&u&&(e.j41(0,"ion-item")(1,"ion-label")(2,"h3"),e.EFF(3),e.k0s(),e.j41(4,"p"),e.EFF(5),e.nI1(6,"date"),e.k0s(),e.DNE(7,Ft,3,4,"p",4),e.k0s()()),2&u){const r=a.$implicit;e.R7$(3),e.JRh(r.station_name||"Unknown Station"),e.R7$(2),e.SpI("\u5230\u7740: ",e.i5U(6,3,r.arrived_at,"HH:mm:ss")),e.R7$(2),e.Y8G("ngIf",r.departed_at)}}function kt(u,a){if(1&u&&(e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3),e.k0s()(),e.j41(4,"ion-card-content")(5,"ion-list"),e.DNE(6,_t,8,6,"ion-item",18),e.k0s()()()),2&u){const r=e.XpG();e.R7$(3),e.SpI("\u4eca\u65e5\u306e\u8a2a\u554f\u99c5 (",r.todayVisits.length,"\u4ef6)"),e.R7$(3),e.Y8G("ngForOf",r.todayVisits)}}function It(u,a){if(1&u){const r=e.RV6();e.j41(0,"ion-card")(1,"ion-card-content",19),e.nrm(2,"ion-icon",20),e.j41(3,"h2"),e.EFF(4,"\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u4f4d\u7f6e\u8ffd\u8de1"),e.k0s(),e.j41(5,"p"),e.EFF(6,"\u30a2\u30d7\u30ea\u304c\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u3067\u3082\u99c5\u3078\u306e\u5230\u7740\u30fb\u51fa\u767a\u3092\u81ea\u52d5\u8a18\u9332\u3057\u307e\u3059"),e.k0s(),e.j41(7,"ion-button",21),e.bIt("click",function(){c.eBV(r);const n=e.XpG();return c.Njj(n.toggleTracking())}),e.nrm(8,"ion-icon",22),e.EFF(9," \u8ffd\u8de1\u958b\u59cb "),e.k0s()()()}}let Mt=(()=>{var u;class a{constructor(t,n,i,o){this.integratedGeofence=t,this.geofenceManager=n,this.cloudSync=i,this.stationService=o,this.trackingStatus={isActive:!1,nativeGeofencing:!1,jsGeofencing:!1,backgroundMode:!1,cloudSync:!1,activeRegions:0,lastLocationUpdate:null,batteryOptimized:!0},this.geofenceStats={activeRegions:0,maxRegions:20,nearbyStations:0,totalStations:0,lastOptimization:null},this.syncStatus={isOnline:!1,lastSync:null,pendingEvents:0,syncErrors:0,totalEventsSynced:0},this.currentLocation=null,this.nearbyStations=[],this.todayVisits=[],this.isInitializing=!1,this.subscriptions=[]}ngOnInit(){var t=this;return(0,h.A)(function*(){try{t.isInitializing=!0,yield t.integratedGeofence.initialize(),t.subscriptions.push(t.integratedGeofence.getTrackingStatus().subscribe(n=>{t.trackingStatus=n})),t.subscriptions.push(t.geofenceManager.getStats().subscribe(n=>{t.geofenceStats=n})),t.subscriptions.push(t.cloudSync.getSyncStatus().subscribe(n=>{t.syncStatus=n})),t.subscriptions.push(t.geofenceManager.getCurrentLocation().subscribe(n=>{t.currentLocation=n,n&&t.loadNearbyStations(n.latitude,n.longitude)})),yield t.loadTodayVisits()}catch(n){console.error("Failed to initialize home page:",n)}finally{t.isInitializing=!1}})()}ngOnDestroy(){this.subscriptions.forEach(t=>t.unsubscribe())}toggleTracking(){var t=this;return(0,h.A)(function*(){try{t.trackingStatus.isActive?yield t.integratedGeofence.stopTracking():(yield t.integratedGeofence.startTracking())||console.error("Failed to start integrated tracking")}catch(n){console.error("Failed to toggle tracking:",n)}})()}loadNearbyStations(t,n){var i=this;return(0,h.A)(function*(){try{i.nearbyStations=(yield i.stationService.getNearbyStations(t,n).toPromise())||[]}catch(o){console.error("Failed to load nearby stations:",o)}})()}loadTodayVisits(){var t=this;return(0,h.A)(function*(){try{const n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()),o=new Date(i);o.setDate(o.getDate()+1),t.todayVisits=(yield t.stationService.getVisitsByDateRange(i.toISOString(),o.toISOString()).toPromise())||[]}catch(n){console.error("Failed to load today visits:",n)}})()}forceOptimization(){var t=this;return(0,h.A)(function*(){try{yield t.geofenceManager.forceOptimization(),console.log("Manual optimization completed")}catch(n){console.error("Manual optimization failed:",n)}})()}forcSync(){var t=this;return(0,h.A)(function*(){try{yield t.cloudSync.forcSync(),console.log("Manual sync completed")}catch(n){console.error("Manual sync failed:",n)}})()}getSystemStatus(){var t=this;return(0,h.A)(function*(){try{const n=yield t.integratedGeofence.getSystemStatus();return console.log("System status:",n),n}catch(n){return console.error("Failed to get system status:",n),null}})()}getTrackingStatusColor(){return this.trackingStatus.isActive?this.trackingStatus.nativeGeofencing&&this.trackingStatus.backgroundMode?"success":this.trackingStatus.jsGeofencing?"warning":"danger":"medium"}getSyncStatusColor(){return this.syncStatus.isOnline?this.syncStatus.pendingEvents>10||this.syncStatus.syncErrors>5?"warning":"success":"danger"}getBatteryOptimizationColor(){return this.trackingStatus.batteryOptimized?"success":"warning"}formatEventTime(t){return new Date(t).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}getEventIcon(t){return"enter"===t?"log-in":"log-out"}getEventColor(t){return"enter"===t?"success":"warning"}calculateDistance(t){if(!this.currentLocation)return null;const i=this.currentLocation.latitude*Math.PI/180,o=t.latitude*Math.PI/180,d=(t.latitude-this.currentLocation.latitude)*Math.PI/180,f=(t.longitude-this.currentLocation.longitude)*Math.PI/180,g=Math.sin(d/2)*Math.sin(d/2)+Math.cos(i)*Math.cos(o)*Math.sin(f/2)*Math.sin(f/2),l=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g));return Math.round(6371e3*l)}static#t=u=()=>(this.\u0275fac=function(n){return new(n||a)(e.rXU(dt),e.rXU(S),e.rXU(it),e.rXU(ot.k))},this.\u0275cmp=e.VBU({type:a,selectors:[["app-home"]],decls:26,vars:15,consts:[[3,"translucent"],[3,"fullscreen"],["collapse","condense"],["size","large"],[4,"ngIf"],[2,"margin-left","10px",3,"color"],["expand","block",3,"click","color","disabled"],["class","tracking-details",4,"ngIf"],["class","status-info",4,"ngIf"],["type","indeterminate"],[1,"tracking-details"],["lines","none"],[3,"color"],["color","primary"],[1,"status-info"],["lines","none",4,"ngIf"],["expand","block","fill","outline",3,"click"],["expand","block","fill","outline",3,"click","disabled"],[4,"ngFor","ngForOf"],[2,"text-align","center","padding","40px"],["name","location-outline","size","large","color","medium"],["color","primary","size","large",3,"click"],["name","play","slot","start"]],template:function(n,i){1&n&&(e.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"\u99c5\u8a18\u9332\u30a2\u30d7\u30ea - \u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u5bfe\u5fdc"),e.k0s()()(),e.j41(4,"ion-content",1)(5,"ion-header",2)(6,"ion-toolbar")(7,"ion-title",3),e.EFF(8,"\u99c5\u8a18\u9332\u30a2\u30d7\u30ea"),e.k0s()()(),e.DNE(9,I,5,0,"ion-card",4),e.j41(10,"ion-card")(11,"ion-card-header")(12,"ion-card-title"),e.EFF(13," \u7d71\u5408\u4f4d\u7f6e\u8ffd\u8de1\u30b7\u30b9\u30c6\u30e0 "),e.j41(14,"ion-badge",5),e.EFF(15),e.k0s()()(),e.j41(16,"ion-card-content")(17,"ion-button",6),e.bIt("click",function(){return i.toggleTracking()}),e.EFF(18),e.k0s(),e.DNE(19,C,21,8,"div",7)(20,j,6,9,"div",8),e.k0s()(),e.DNE(21,R,30,11,"ion-card",4)(22,U,11,1,"ion-card",4)(23,At,7,2,"ion-card",4)(24,kt,7,2,"ion-card",4)(25,It,10,0,"ion-card",4),e.k0s()),2&n&&(e.Y8G("translucent",!0),e.R7$(4),e.Y8G("fullscreen",!0),e.R7$(5),e.Y8G("ngIf",i.isInitializing),e.R7$(5),e.Y8G("color",i.getTrackingStatusColor()),e.R7$(),e.SpI(" ",i.trackingStatus.isActive?"\u30a2\u30af\u30c6\u30a3\u30d6":"\u505c\u6b62\u4e2d"," "),e.R7$(2),e.Y8G("color",i.trackingStatus.isActive?"danger":"primary")("disabled",i.isInitializing),e.R7$(),e.SpI(" ",i.trackingStatus.isActive?"\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u8ffd\u8de1\u505c\u6b62":"\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u8ffd\u8de1\u958b\u59cb"," "),e.R7$(),e.Y8G("ngIf",i.trackingStatus.isActive),e.R7$(),e.Y8G("ngIf",i.currentLocation),e.R7$(),e.Y8G("ngIf",i.trackingStatus.isActive),e.R7$(),e.Y8G("ngIf",i.trackingStatus.isActive),e.R7$(),e.Y8G("ngIf",i.nearbyStations.length>0),e.R7$(),e.Y8G("ngIf",i.todayVisits.length>0),e.R7$(),e.Y8G("ngIf",!i.trackingStatus.isActive&&!i.isInitializing))},dependencies:[T.MD,T.Sq,T.bT,M.eU,M.ai,M.BC,M.W9,M.Jm,M.b_,M.I9,M.ME,M.tN,M.iq,M.uz,M.he,M.In,M.nf,M.FH,T.QX,T.vh],styles:[".tracking-status[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.location-info[_ngcontent-%COMP%]{margin-top:16px;padding:12px;background:var(--ion-color-light);border-radius:8px}.location-info[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 8px;font-family:monospace;font-size:.9em;color:var(--ion-color-medium)}.stats-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:16px;text-align:center}.stat-item[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:2em;font-weight:700}.stat-item[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:4px 0 0;font-size:.9em;text-transform:uppercase;letter-spacing:.5px}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:40px 20px}.empty-state[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-bottom:16px}.empty-state[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{color:var(--ion-color-dark);margin:0 0 8px}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--ion-color-medium);margin:0 0 24px}ion-chip[_ngcontent-%COMP%]{--background: var(--ion-color-light)}ion-list[_ngcontent-%COMP%]{padding:0}ion-item[_ngcontent-%COMP%]{--padding-start: 0;--inner-padding-end: 0}ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin:12px 0}ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 4px;font-weight:600}ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:2px 0;font-size:.9em}.tracking-status[_ngcontent-%COMP%]   ion-chip[_ngcontent-%COMP%]{transition:all .3s ease}.tracking-status[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{transition:all .3s ease}"]}))}return u(),a})()}}]);